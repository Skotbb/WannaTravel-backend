{"version":3,"sources":["../../routes/parse.js"],"names":["express","require","moment","_","mongoose","Horseman","parsingManager","router","Router","countriesILike","get","req","res","next","socket","setTimeout","addListener","destroy","days","params","dow","dayOfWeek","dep","ret","dates","getTravelDates","horseman","timeout","console","log","pageTitle","countries","on","msg","open","getUrl","title","then","waitForSelector","click","screenshot","evaluate","$","each","children","name","find","text","searchHref","attr","country","search","indexOf","push","results","length","findOne","err","result","searchUrl","save","error","e","render","message","catch","close","module","exports"],"mappings":"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","file":"parse.js","sourcesContent":["var express = require('express');\r\nconst moment = require('moment')\r\nconst _ = require('lodash')\r\nconst mongoose = require('mongoose')\r\nvar Horseman = require('node-horseman')\r\nvar parsingManager = require('../public/javascripts/parsingManager')\r\n// var databaseName =  require('../travel-settings')\r\n\r\n//Models\r\nimport { Country } from '../models/country'\r\n\r\nvar router = express.Router();\r\n\r\n// let countriesILike = [\r\n// \t\"Ireland\", \"United Kingdom\", \"Australia\", \"Spain\", \"Canada\", \"Italy\", \"New Zealand\", \"Germany\", \"Netherlands\",\r\n// \t\"Japan\", \"Ireland\", \"Greece\", \"Norway\", \"Sweden\", \"Denmark\", \"Iceland\"\r\n// ]\r\nlet countriesILike = [\"Ireland\"]\r\n\r\n/* GET selections from form. */\r\nrouter.get('/:days/:dayOfWeek', function(req, res, next) {\r\n\treq.socket.setTimeout(30 * 60 * 1000)\r\n\treq.socket.addListener('timeout', function() {\r\n\t\treq.socket.destroy()\r\n\t})\r\n\t// let dbString = \"mongodb://localhost/\" + databaseName.databaseName\r\n\t// mongoose.connect(dbString);\r\n\r\n\ttry {\r\n\t\t// Get form variables\r\n\t\tvar days = req.params.days\r\n\t\tvar dow = req.params.dayOfWeek\r\n\r\n\t\tvar dep = null\r\n\t\tvar ret = null\r\n\r\n\t\tvar dates = getTravelDates(dow, days)\r\n\t\tvar horseman = new Horseman({timeout: 10000})\r\n\t\t//  \"http://www.momondo.com/flights/mco-1/any-6/flights-from-orlando-intl-to-take-me-anywhere.html?TripType=2&SegNo=2&SDP0=03-05-2017&SDP1=10-05-2017&AD=1&TK=ECO&DO=false&NA=false\"\r\n\t\t//var url = \"http://www.momondo.com/flights/mco-1/any-6/flights-from-orlando-intl-to-take-me-anywhere.html?TripType=2&SegNo=2&SDP0=\" +dep+ \"&SDP1=\" +ret+ \"&AD=1&TK=ECO&DO=false&NA=false\"\r\n\t\tconsole.log(\"Horseman created\")\r\n\t\t// Variables from page\r\n\t\tvar pageTitle = ''\r\n\t\tvar countries = []\r\n\r\n\t\thorseman\r\n\t\t\t.on(\"consoleMessage\", function(msg){\r\n\t\t\t\tconsole.log(msg);\r\n\t\t\t})\r\n\t\t\t.open(getUrl(dates.dep, dates.ret))\r\n\t\t\t.title()\r\n\t\t\t.then(function (title) {\r\n\t\t\t\tconsole.log(\"Open\")\r\n\t\t\t\tpageTitle = title\r\n\t\t\t\tconsole.log(title)\r\n\t\t\t\t//res.render('results', {title: title, message: \"Momondo?\"});\r\n\t\t\t})\r\n\t\t\t.waitForSelector('div.ng-scope > div > div.flexiblesearch-option-content > label:nth-child(2) > div > span')\r\n\t\t\t.click('div.ng-scope > div > div.flexiblesearch-option-content > label:nth-child(2) > div > span')\r\n\t\t\t.log(\"Sorting by most popular\")\r\n\t\t\t.waitForSelector('div.flexiblesearch-main.ng-scope > div:nth-child(2) > div > div.ng-scope > div:nth-child(1) > span:nth-child(1) > div > div > a > span.flexiblesearch-result-button.ng-scope')\r\n\t\t\t.screenshot(\"screen.png\")\r\n\t\t\t.evaluate(function(countriesILike) {\r\n\t\t\t\tvar countries = []\r\n\t\t\t\tconsole.log(\"In page.\")\r\n\t\t\t\tconsole.log(countriesILike)\r\n\r\n\t\t\t\t$('div.mui-goexplore-result-row.ng-scope')\r\n\t\t\t\t\t.each(function() {\r\n\t\t\t\t\t\t$(this).children()\r\n\t\t\t\t\t\t\t.each(function () {\r\n\t\t\t\t\t\t\t\tvar name = $(this).find('div > div.container > a > span.city.ng-binding').text()\r\n\t\t\t\t\t\t\t\tvar searchHref = $(this).find('div > div.container > a').attr('href')\r\n\t\t\t\t\t\t\t\t// console.log(name)\r\n\t\t\t\t\t\t\t\tvar country = {\r\n\t\t\t\t\t\t\t\t\tname: name,\r\n\t\t\t\t\t\t\t\t\tsearch: 'http://www.momondo.com' + searchHref\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif(_.indexOf(countriesILike, country.name) !== -1) {\r\n\t\t\t\t\t\t\t\t\tcountries.push(country)\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t})\r\n\t\t\t\treturn countries\r\n\t\t\t}, countriesILike)\r\n\t\t\t.then(async function (results) {\r\n\t\t\t\tconsole.log(`Checking ${results.length} countries.`)\r\n\t\t\t\tcountries = results\r\n\r\n\t\t\t\tfor(let country of countries) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tCountry.findOne({name: country.name}, (err, result) => {\r\n\t\t\t\t\t\t\t// If no error\r\n\t\t\t\t\t\t\tif (!err) {\r\n\t\t\t\t\t\t\t\t// If no result\r\n\t\t\t\t\t\t\t\tif (!result) {\r\n\t\t\t\t\t\t\t\t\t// Create the country!\r\n\t\t\t\t\t\t\t\t\tresult = new Country({\r\n\t\t\t\t\t\t\t\t\t\tname: country.name,\r\n\t\t\t\t\t\t\t\t\t\tsearchUrl: country.search\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\tconsole.log(`${country.name} created.`)\r\n\t\t\t\t\t\t\t\t\t//Save new Country!\r\n\t\t\t\t\t\t\t\t\tresult.save((error) => {\r\n\t\t\t\t\t\t\t\t\t\tif (error) {\r\n\t\t\t\t\t\t\t\t\t\t\tthrow error;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tconsole.log(\"Saved.\")\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t} catch (e) {\r\n\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t//countries = await parsingManager.parseCountry(countries)\r\n\r\n\t\t\t\tres.render('results', {title: pageTitle, message: \"Yooo, Momondo\"})\r\n\t\t\t})\r\n\t\t\t.catch(function(error) {\r\n\t\t\t\tconsole.log(error)\r\n\t\t\t})\r\n\t\t\t.log(\"Closing.\")\r\n\t\t\t.close()\r\n\t} catch (e) {\r\n\t\tconsole.log(e)\r\n\t}\r\n});\r\n\r\n\r\nmodule.exports = router;\r\n"]}